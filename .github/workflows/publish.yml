name: Publish Package

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run typecheck

      - name: Run tests
        run: npm run test

      - name: Build package
        run: npm run build

  publish-npm:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "18"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Publish to NPM (Trusted Publishing with NPM_TOKEN fallback)
        run: |
          # Backup original package.json
          cp package.json package.json.backup
          
          # Function to try publishing with current package.json
          try_publish() {
            local package_name=$(node -p "require('./package.json').name")
            echo "ðŸ“¦ Attempting to publish: $package_name"
            
            if npm publish; then
              echo "âœ… Successfully published: $package_name"
              return 0
            else
              echo "âŒ Failed to publish: $package_name"
              return 1
            fi
          }
          
          # Function to setup token authentication
          setup_token_auth() {
            if [ -n "$NPM_TOKEN" ]; then
              echo "ðŸ”‘ Setting up NPM_TOKEN authentication..."
              
              # Prefer GitHub-provided NPM_CONFIG_USERCONFIG (set by setup-node) or fallback to ~/.npmrc
              NPM_USER_CONFIG="${NPM_CONFIG_USERCONFIG:-$HOME/.npmrc}"
              
              # Ensure directory exists
              mkdir -p "$(dirname "$NPM_USER_CONFIG")"
              
              # Override any existing auth with the provided NPM_TOKEN
              {
                echo "registry=https://registry.npmjs.org/"
                echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN"
                echo "always-auth=true"
              } > "$NPM_USER_CONFIG"
              
              # Export for npm cli to pick it up
              export NODE_AUTH_TOKEN="$NPM_TOKEN"
              echo "âœ… NPM_TOKEN configured at $NPM_USER_CONFIG"
              return 0
            else
              echo "âš ï¸  NPM_TOKEN not available, skipping token authentication"
              return 1
            fi
          }
          
          PUBLISH_SUCCESS=false
          AUTH_METHOD="Trusted Publishing (OIDC)"
          
          # Step 1: Try with original name using Trusted Publishing
          ORIGINAL_NAME=$(node -p "require('./package.json').name")
          echo "ðŸ” Using authentication method: $AUTH_METHOD"
          
          if try_publish; then
            PUBLISH_SUCCESS=true
            echo "âœ… Published using $AUTH_METHOD"
          else
            echo "âš ï¸  Trusted Publishing failed, trying with scoped name..."
            # Restore backup (keep backup for later fallback attempts)
            cp package.json.backup package.json
            
            # Step 2: Try with scoped name using Trusted Publishing
            node -e "
              const pkg = require('./package.json');
              const owner = process.env.GITHUB_REPOSITORY.split('/')[0];
              const originalName = pkg.name.replace(/^@[^/]+\//, ''); // Remove existing scope if any
              pkg.name = \`@\${owner}/\${originalName}\`;
              pkg.publishConfig = { 
                access: 'public',
                registry: 'https://registry.npmjs.org'
              };
              console.log(\`ðŸ“¦ Retrying with scoped name: \${pkg.name}\`);
              require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            "
            
            if try_publish; then
              PUBLISH_SUCCESS=true
              echo "âœ… Published using $AUTH_METHOD with scoped name"
            else
              echo "âš ï¸  Trusted Publishing failed, attempting fallback to NPM_TOKEN..."
              
              # Step 3: Fallback to NPM_TOKEN if available
              if setup_token_auth; then
                AUTH_METHOD="NPM_TOKEN (fallback)"
                # Restore original package.json and try again (leave backup intact)
                cp package.json.backup package.json
                
                if try_publish; then
                  PUBLISH_SUCCESS=true
                  echo "âœ… Published using $AUTH_METHOD"
                else
                  # Try scoped name with token
                  node -e "
                    const pkg = require('./package.json');
                    const owner = process.env.GITHUB_REPOSITORY.split('/')[0];
                    const originalName = pkg.name.replace(/^@[^/]+\//, '');
                    pkg.name = \`@\${owner}/\${originalName}\`;
                    pkg.publishConfig = { 
                      access: 'public',
                      registry: 'https://registry.npmjs.org'
                    };
                    require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
                  "
                  
                  if try_publish; then
                    PUBLISH_SUCCESS=true
                    echo "âœ… Published using $AUTH_METHOD with scoped name"
                  fi
                fi
              fi
            fi
          fi
          
          # Always restore original package.json if backup exists
          if [ -f package.json.backup ]; then
            cp package.json.backup package.json
            echo "ðŸ”„ Restored original package.json"
          fi
          
          # Final check
          if [ "$PUBLISH_SUCCESS" = false ]; then
            echo "âŒ Failed to publish with all authentication methods"
            echo ""
            echo "ðŸ” Troubleshooting:"
            echo "1. Ensure Trusted Publishing is enabled in your npm account:"
            echo "   https://www.npmjs.com/settings/YOUR_USERNAME/access-tokens"
            echo "2. Verify the workflow path matches: .github/workflows/publish.yml"
            echo "3. Alternatively, set NPM_TOKEN secret in repository settings"
            echo "4. Check package name availability and permissions"
            exit 1
          fi
          
          SCOPED_NAME=$(node -p "require('./package.json').name" 2>/dev/null || echo "$ORIGINAL_NAME")
          if [[ "$SCOPED_NAME" == @* ]]; then
            echo "ðŸ’¡ Users can install with: npm install $SCOPED_NAME"
          fi
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-github:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "18"
          registry-url: "https://npm.pkg.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Configure package for GitHub
        run: |
          # Create a temporary package.json for GitHub publishing
          cp package.json package.json.backup
          node -e "
            const pkg = require('./package.json');
            const owner = process.env.GITHUB_REPOSITORY.split('/')[0];
            const repoName = process.env.GITHUB_REPOSITORY.split('/')[1];
            
            // Use the repository name for GitHub Packages to avoid URL encoding issues
            pkg.name = \`@\${owner}/\${repoName}\`;
            pkg.publishConfig = {
              registry: 'https://npm.pkg.github.com',
              access: 'public'
            };
            
            console.log(\`ðŸ“¦ Publishing to GitHub Packages as: \${pkg.name}\`);
            console.log(\`ðŸŽ¯ Repository: \${process.env.GITHUB_REPOSITORY}\`);
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Publish to GitHub Packages
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore package.json
        run: mv package.json.backup package.json
